<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Prices & SMA-5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Stock Prices & SMA-5 (60 min)</h2>

    <!-- Stock Selection -->
    <label for="stockSelect">Choose a Stock:</label>
    <select id="stockSelect">
        <option value="AAPL">Apple (AAPL)</option>
        <option value="TSLA">Tesla (TSLA)</option>
        <option value="META">Meta (META)</option>
        <option value="F">Ford (F)</option>
        <option value="MSFT">Microsoft (MSFT)</option>
    </select>
    <button onclick="fetchStockData()">Get Stock Data</button>

    <br><br>

    <!-- Stock Price Table -->
    <table border="1" cellpadding="5">
        <thead>
            <tr>
                <th>Date</th>
                <th>Open</th>
                <th>High</th>
                <th>Low</th>
                <th>Close</th>
                <th>Volume</th>
                <th>SMA-5</th>
            </tr>
        </thead>
        <tbody id="stockTableBody"></tbody>
    </table>

    <br>

    <!-- Chart.js Graph -->
    <canvas id="stockChart" width="600" height="300"></canvas>

    <script>
        async function fetchStockData() {
            const stockSymbol = document.getElementById("stockSelect").value;
            try {
                const response = await fetch(`http://localhost:3000/stock/${stockSymbol}`);
                const data = await response.json();
                displayStockTable(data);
                drawStockChart(data, stockSymbol);
            } catch (error) {
                console.error("Error fetching stock data:", error);
            }
        }

        function displayStockTable(data) {
            const tableBody = document.getElementById("stockTableBody");
            tableBody.innerHTML = "";

            data.forEach(entry => {
                const row = `<tr>
                    <td>${new Date(entry.date).toLocaleDateString()}</td>
                    <td>${entry.open.toFixed(2)}</td>
                    <td>${entry.high.toFixed(2)}</td>
                    <td>${entry.low.toFixed(2)}</td>
                    <td>${entry.close.toFixed(2)}</td>
                    <td>${entry.volume.toLocaleString()}</td>
                    <td>${entry.sma ? entry.sma.toFixed(2) : "N/A"}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function drawStockChart(data, stockSymbol) {
            const ctx = document.getElementById("stockChart").getContext("2d");
            const labels = data.map(d => new Date(d.date).toLocaleDateString());
            const closePrices = data.map(d => d.close);
            const sma5 = data.map(d => d.sma);

            new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `${stockSymbol} Close Price`,
                            data: closePrices,
                            borderColor: "blue",
                            fill: false
                        },
                        {
                            label: `${stockSymbol} SMA-5`,
                            data: sma5,
                            borderColor: "red",
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { display: true },
                        y: { display: true }
                    }
                }
            });
        }

        // Fetch initial stock data on page load
        fetchStockData();
    </script>
</body>
</html>
